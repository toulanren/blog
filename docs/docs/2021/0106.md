# 玩转群晖：外网访问安全策略

首先祝大家新年快乐，新年第一篇，就来讲讲我在外网访问群晖时，所使用的安全策略。

> 以下操作都基于：DS918+ & DSM 6.2.3-25426 Update 2

## 查看所有端口

访问一台服务器，是通过各种各样的端口，所以，归根到底外网访问的安全，就是端口的安全。

作为一个服务器，端口有很多，我们可以通过防火墙来查看群晖使用了哪些端口，步骤如下：

1. 打开控制面板 - 安全性 - 防火墙
2. 勾选“启用防火墙”，点击下方的编辑规则
3. 点击新增规则，“端口”选项下，选择“从内置服务的列表选择端口”，点击即可看到所有端口。

图示：

![image](https://user-images.githubusercontent.com/45085199/124558197-ed0fc500-de6c-11eb-82af-dfd47bc5f722.png)

## 安全策略

### 修改默认端口

既然访问服务器是通过端口，那么首先第一条，能够修改默认端口就一定要修改默认端口，归纳一下，有这几部分按需更改：

1. 群晖 DSM 端口
2. 群晖 telnet、ssh 的端口
3. 安装套件的默认端口
4. docker 服务的默认端口

#### 群晖 dsm

这是群晖的主要端口，是最直接访问群晖的地方，所以外网访问，尽量将 http 和 https 修改成其他端口。

修改步骤：

- 控制面板 - 网络 - DSM 设置 - DSM 端口
- 控制面板 - 外部访问 - 高级设置

> 实际测试，在“外部访问”里面的设置并不生效，不知为何。

#### 群晖 ssh

这两个端口，能直接通过命令行访问系统，网络上经常有黑客通过默认端口扫描肉鸡，可以说是最重要的。

修改步骤：

- 控制面板 - 终端机和 SNMP - 终端机

使用 ssh 就行，对于使用，你有这几个选择：

1. 在需要的时候去开启 ssh，不需要的适合就关闭 ssh
2. 一直开启 ssh，修改其他端口

对于上面两个选择，1 是安全性最高的，但是经常会忘记去关。。所以个人建议一直开启 ssh，修改成自己的端口，这样只要你不说，就不会有人知道。

#### 套件端口

一般来说套件没有修改端口的选项，一些第三方套件的可能会有，这里就不做太多的描述了，建议不要使用默认端口。

#### docker 服务端口

docker 服务在映射时尽量不要使用默认的端口，比如 jellyfin 的 8096，可以使用如 8020:8096、30300:8096

### 使用 https

服务器使用最多的还是 tcp 协议，所以 https 还是很有必要的。证书在这个地方去导入和设置：

- 控制面板 - 安全性 - 证书

新增证书后，通过配置，去应用到你想要的服务上。

### 反向代理服务器

反向代理服务器是一个很好用的东西，目前我用到了以下功能：

1. 将 http 服务代理为 https
2. 自定义公开站点的域名

面板为：控制面板 - 应用程序门户 - 反向代理服务器

#### 将 http 服务代理为 https

这个功能一般是给 docker 服务来用的，因为站点现在都建议使用 https，但是给 docker 服务去配置 https 是很麻烦的，且不论每个服务的 https 配置都不一样，单单说证书过期后都要替换一遍，想想都觉得麻烦。

而用反向代理服务器去实现就简单多了，举个例子，比如你的服务器是 abc.com，jellyfin 的 http 是 abc.com:8096，希望使用 https 去访问，就可以在反向代理服务器点击新增，这样配置：

![image](https://user-images.githubusercontent.com/45085199/124558232-f39e3c80-de6c-11eb-994e-3538188973fd.png)

这样就可以通过 https://abc.com:8097 去访问了。

假设你有 100 个 docker 服务配置了 https 的反向代理，那么证书过期的时候，只需要去：控制面板 - 安全性 - 证书 这里更新一下 abc.com 的证书，就 OK 了。

#### 自定义公开站点的域名

这个功能的场景是这样的：

假设你的服务器是 abc.com，你想搭建一个博客，但是正常搭建好了之后，域名可能会是 abc.com:8080 这样。

黑客看到了，就可能会去试试 abc.com:5000 或者 ssh 访问，黑客就知道你的服务器地址是 abc.com。

所以这样时候，有一些外部站点不想让人知道，又或者我们想又一个专门的域名去对应某个服务。

就比如我的博客和所用到的图床，都是装在服务器上，但是却是 https://toulanren.com 和 https://images.toulanren.com ，这样既美观，又较为安全。

> 其实从安全上来说，防君子不防小人，外部的站点，想找到服务器的域名，还是有办法的。所以主要是美观。

配置的话，类似上面那张图，我拿这：[玩转群晖：部署全套 GitLab 的方案](docs/2020/1201.md) 里面配置的截图来用一下。

我的服务器是 a.com，博客是是 http://a.com:48443 ，但是我希望访问是：https://abc.com:48444 ，那就可以这样配置：

![image](https://user-images.githubusercontent.com/45085199/124558249-f862f080-de6c-11eb-9605-02777de7b939.png)

当然这样还不够，还需要这几步：

1. abc.com 域名解析使用 CNAME 到 a.com
2. 拿到 abc.com 的 ssl 证书，并新增到服务器。
3. 在：控制面板 - 安全性 - 证书 - 配置，将 abc.com:48444 这个服务的证书由默认的 a.com 修改成 abc.com

这样就可以了，以上 a.com 和 abc.com 替换成你自己的域名。

#### 防火墙关闭目的地

配置完反向代理服务器，可以看到有：描述、来源、目的地 这三栏。

目的地一般是 localhost:xxxx ，localhost 代表服务器，而这个端口，也是可以通过服务器域名访问的。

但是我们不需要访问，那么可以通过防火墙关闭掉。

进入到防火墙，打开后，添加配置，以上面 jellyfin 的为例，已经代理了 8097，所以 8096 需要禁止掉：

> 下面端口写错成了 8086，懒得换图了，改成你自己想要封的就行

![image](https://user-images.githubusercontent.com/45085199/124558270-00229500-de6d-11eb-9d4f-2262107de16c.png)

这样，8096 端口就无法访问了，可以安心使用 https://abc.com:8097 了。
